name: DevSecOps Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-test-security:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Configurar Node (exemplo)
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Instalar dependências
        run: npm install

      # --- LINT ---
      - name: Lint de código
        run: npm run lint --if-present

      # --- TESTES ---
      - name: Executar testes
        run: npm test --if-present

      # --- SAST (Static Application Security Testing) ---
      - name: SAST com CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
      - name: Analisar com CodeQL
        uses: github/codeql-action/analyze@v3

      # --- SCAN DE DEPENDÊNCIAS ---
      - name: Scan de dependências com OWASP Dependency-Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: "MeuProjeto"
          path: "."

      # --- BUILD ---
      - name: Build da aplicação
        run: npm run build --if-present

      # --- SCAN DE CONTAINER (caso use docker) ---
      - name: Scan Docker com Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: .

      # --- BLUE TEAM: LOGS / HARDENING ---
      - name: Verificação de segurança da pipeline
        run: |
          echo "[BlueTeam] Verificando variáveis sensíveis não expostas..."
          # Adicionar regras específicas aqui

      # --- RED TEAM (simulação simples) ---
      - name: Teste Red Team - ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: "http://localhost:3000"

      # --- PURPLE TEAM ---
      - name: Registro de recomendações Purple Team
        run: |
          echo "Integrando achados de Red + Blue Team"
          # aqui você cria arquivo de recomendação
