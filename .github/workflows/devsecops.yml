name: DevSecOps Pipeline Java

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  security-events: write  # Necessário para CodeQL upload em branches internas

jobs:
  devsecops:
    runs-on: ubuntu-latest

    steps:
      # ------------------ CHECKOUT ------------------
      - name: Checkout código
        uses: actions/checkout@v4

      # ------------------ JAVA / MAVEN ------------------
      - name: Instalar Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Instalar Maven
        uses: stCarolas/setup-maven@v4

      # ------------------ LINT ------------------
      - name: Lint (Checkstyle)
        run: mvn checkstyle:check

      # ------------------ TESTES ------------------
      - name: Executar Testes
        run: mvn test

      # ------------------ BUILD ------------------
      - name: Build Maven (para produção)
        run: mvn package -DskipTests=false

      # ------------------ CODEQL ------------------
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java

      - name: Build Java para CodeQL
        run: mvn clean compile

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      # ------------------ SAST (SEMGREP) ------------------
      - name: Semgrep SAST
        uses: returntocorp/semgrep-action@v1
        with:
          config: |
            p/owasp-top-ten
            p/java
            auto

      # ------------------ BLUE TEAM ------------------
      - name: Blue Team – Validar Configurações
        run: |
          echo "[BLUE] Verificando permissões..."
          echo "[BLUE] Validando variáveis e dependências críticas..."

      # ------------------ PURPLE TEAM ------------------
      - name: Purple Team – Registrar recomendações
        run: |
          echo "Registro de recomendações Red + Blue Team" > purple-team.log

  # -------------------------------------------------------------------------
  # DEPLOY BLUE/GREEN SIMULADO
  # -------------------------------------------------------------------------
  deploy-blue-green:
    needs: devsecops
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ------------------ SIMULAÇÃO DE BUILD ------------------
      - name: Simular build das imagens BLUE e GREEN
        run: |
          echo "[SIMULAÇÃO] Build da imagem BLUE concluída"
          echo "[SIMULAÇÃO] Build da imagem GREEN concluída"

      # ------------------ DEPLOY SIMULADO ------------------
      - name: Deploy Blue via SSH (simulado)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          script: |
            cd /opt/devsecops
            echo "[SIMULAÇÃO] Deploy app-blue realizado"

      - name: Deploy Green via SSH (simulado)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          script: |
            cd /opt/devsecops
            echo "[SIMULAÇÃO] Deploy app-green realizado"

      # ------------------ HEALTH CHECK ------------------
      - name: Testar ambiente GREEN (simulado)
        run: |
          echo "[SIMULAÇÃO] Health check passado para app-green"

      # ------------------ PROMOVER GREEN ------------------
      - name: Promover GREEN para produção (simulado)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          script: |
            echo "[SIMULAÇÃO] GREEN promovido para produção"

      # ------------------ ROLLBACK AUTOMÁTICO ------------------
      - name: Rollback (se falhar, simulado)
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          script: |
            echo "[SIMULAÇÃO] Rollback realizado, app-blue restaurado"
