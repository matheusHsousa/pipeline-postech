name: DevSecOps Pipeline Java + Fortify

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  devsecops:
    runs-on: ubuntu-latest

    steps:
      # ------------------ CODE CHECKOUT ------------------
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      # ------------------ JAVA / MAVEN ------------------
      - name: Instalar Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Instalar Maven
        uses: stCarolas/setup-maven@v4

      # ------------------ LINT ------------------
      - name: Lint (Checkstyle)
        run: mvn checkstyle:check

      # ------------------ TESTES ------------------
      - name: Executar Testes
        run: mvn test

      # ------------------ BUILD ------------------
      - name: Build Maven
        run: mvn package -DskipTests=false

      # ------------------ FORTIFY CE ------------------
      - name: Baixar Fortify CE (√∫ltima vers√£o)
        run: |
          sudo apt-get update && sudo apt-get install -y jq unzip

          echo "üîé Buscando asset ZIP do FortifyCE..."
          LATEST_URL=$(curl -s https://api.github.com/repos/fortify/FortifyCE/releases/latest \
            | jq -r '.assets[] | select(.name | test("linux.*\\.zip$")) | .browser_download_url')

          if [ -z "$LATEST_URL" ]; then
            echo "‚ö† Nenhum ZIP linux encontrado. Usando ZIP universal..."
            LATEST_URL=$(curl -s https://api.github.com/repos/fortify/FortifyCE/releases/latest \
              | jq -r '.assets[] | select(.name | test("\\.zip$")) | .browser_download_url')
          fi

          echo "Baixando: $LATEST_URL"
          wget "$LATEST_URL" -O fortify_ce.zip
          unzip fortify_ce.zip

      - name: Fortify Translate
        run: |
          DIR=$(ls -d Fortify_CE*/)
          echo "Usando diret√≥rio: $DIR"
          chmod +x $DIR/bin/foxt
          $DIR/bin/foxt -b devsecops-build -source src

      - name: Fortify Scan
        run: |
          DIR=$(ls -d Fortify_CE*/)
          echo "Usando diret√≥rio: $DIR"
          chmod +x $DIR/bin/foxs
          $DIR/bin/foxs -b devsecops-build -f fortify-scan.fpr

      # ------------------ DEPENDENCY CHECK ------------------
      - name: OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: "Java-DevSecOps"
          path: "."

      # ------------------ CODEQL ------------------
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      # ------------------ BLUE TEAM ------------------
      - name: Blue Team ‚Äì Validar Configura√ß√µes
        run: |
          echo "[BLUE] Verificando permiss√µes..."
          echo "[BLUE] Validando vari√°veis e depend√™ncias cr√≠ticas..."

      # ------------------ PURPLE TEAM ------------------
      - name: Purple Team ‚Äì Registrar recomenda√ß√µes
        run: |
          echo "Registro de recomenda√ß√µes Red + Blue Team" > purple-team.log

  # -------------------------------------------------------------------------
  # DEPLOY BLUE/GREEN
  # -------------------------------------------------------------------------
  deploy-blue-green:
    needs: devsecops
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ------------------ DOCKER LOGIN ------------------
      - name: Login Docker Registry
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USER }}" --password-stdin

      # ------------------ BUILD GREEN IMAGE ------------------
      - name: Build imagem GREEN
        run: docker build -t ${{ secrets.DOCKER_REPO }}/app:green .

      - name: Push imagem GREEN
        run: docker push ${{ secrets.DOCKER_REPO }}/app:green

      # ------------------ DEPLOY NO SERVIDOR ------------------
      - name: Deploy Green via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          script: |
            cd /opt/devsecops
            docker pull ${{ secrets.DOCKER_REPO }}/app:green
            docker compose up -d app-green

      # ------------------ HEALTH CHECK ------------------
      - name: Testar ambiente GREEN
        run: |
          curl -f http://${{ secrets.SERVER_HOST }}/health || exit 1

      # ------------------ PROMOVER GREEN ------------------
      - name: Promover GREEN para produ√ß√£o
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          script: |
            sed -i 's/app-blue:/app-green:/g' nginx/nginx.conf
            docker compose restart nginx

      # ------------------ ROLLBACK AUTOM√ÅTICO ------------------
      - name: Rollback (se falhar)
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          script: |
            sed -i 's/app-green:/app-blue:/g' nginx/nginx.conf
            docker compose restart nginx
