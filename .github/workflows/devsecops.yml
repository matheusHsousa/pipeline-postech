name: DevSecOps Pipeline Java

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  devsecops:
    runs-on: ubuntu-latest

    steps:
      # ------------------ CHECKOUT ------------------
      - name: Checkout código
        uses: actions/checkout@v4

      # ------------------ JAVA / MAVEN ------------------
      - name: Instalar Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Instalar Maven
        uses: stCarolas/setup-maven@v4

      # ------------------ LINT ------------------
      - name: Lint (Checkstyle)
        run: mvn checkstyle:check

      # ------------------ TESTES ------------------
      - name: Executar Testes
        run: mvn test

      # ------------------ BUILD ------------------
      - name: Build Maven
        run: mvn package -DskipTests=false

      # ------------------ SAST (SEMGREP) ------------------
      - name: Semgrep SAST
        uses: returntocorp/semgrep-action@v1
        with:
          config: |
            p/owasp-top-ten
            p/java
            auto

      # ------------------ OWASP DEPENDENCY CHECK ------------------
      # Cache para o banco de dados do Dependency-Check (dc-data)
      - name: Cache Dependency-Check DB
        uses: actions/cache@v4
        with:
          path: dc-data
          key: dc-db-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            dc-db-${{ runner.os }}-

      - name: Instalar OWASP Dependency Check
        run: |
          set -e
          mkdir -p /tmp/dc
          cd /tmp/dc
          wget -q https://github.com/jeremylong/DependencyCheck/releases/download/v10.0.4/dependency-check-10.0.4-release.zip
          unzip dependency-check-10.0.4-release.zip
          # Ajuste do nome do diretório caso venha com versão no nome
          if [ -d dependency-check ]; then
            sudo rm -rf /opt/dependency-check || true
            sudo mv dependency-check /opt/dependency-check
          else
            # encontra o diretório que começa com dependency-check
            DC_DIR=$(ls -d */ | grep dependency-check | head -n 1 | sed 's#/##')
            sudo rm -rf /opt/dependency-check || true
            sudo mv "$DC_DIR" /opt/dependency-check
          fi
          sudo chmod -R +x /opt/dependency-check/bin || true

      # Baixar/atualizar a base de dados do Dependency-Check (garante existência)
      - name: Atualizar banco do Dependency-Check (update only)
        run: |
          mkdir -p dc-data
          /opt/dependency-check/bin/dependency-check.sh --updateonly --data "$GITHUB_WORKSPACE/dc-data"

      # Executar scanner (não quebra o job por vulnerabilidades)
      - name: Executar Dependency Check (scan)
        env:
          # assegura que o java seja encontrado
          JAVA_HOME: ${{ env.JAVA_HOME }}
        run: |
          mkdir -p reports
          /opt/dependency-check/bin/dependency-check.sh \
            --project "Java-DevSecOps" \
            --scan "." \
            --format "HTML" \
            --out "reports" \
            --data "$GITHUB_WORKSPACE/dc-data" \
            --noupdate \
            --failOnCVSS 11
        # Observação: --failOnCVSS 11 evita que o step falhe devido a CVSS (CVSS max = 10)

      - name: Upload relatórios Dependency Check
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: reports

      # ------------------ CODEQL ------------------
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      # ------------------ BLUE TEAM ------------------
      - name: Blue Team – Validar Configurações
        run: |
          echo "[BLUE] Verificando permissões..."
          echo "[BLUE] Validando variáveis e dependências críticas..."

      # ------------------ PURPLE TEAM ------------------
      - name: Purple Team – Registrar recomendações
        run: |
          echo "Registro de recomendações Red + Blue Team" > purple-team.log

  # -------------------------------------------------------------------------
  # DEPLOY BLUE/GREEN
  # -------------------------------------------------------------------------
  deploy-blue-green:
    needs: devsecops
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ------------------ DOCKER LOGIN ------------------
      - name: Login Docker Registry
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USER }}" --password-stdin

      # ------------------ BUILD GREEN IMAGE ------------------
      - name: Build imagem GREEN
        run: docker build -t ${{ secrets.DOCKER_REPO }}/app:green .

      - name: Push imagem GREEN
        run: docker push ${{ secrets.DOCKER_REPO }}/app:green

      # ------------------ DEPLOY NO SERVIDOR ------------------
      - name: Deploy Green via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          script: |
            cd /opt/devsecops
            docker pull ${{ secrets.DOCKER_REPO }}/app:green
            docker compose up -d app-green

      # ------------------ HEALTH CHECK ------------------
      - name: Testar ambiente GREEN
        run: |
          curl -f http://${{ secrets.SERVER_HOST }}/health || exit 1

      # ------------------ PROMOVER GREEN ------------------
      - name: Promover GREEN para produção
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          script: |
            sed -i 's/app-blue:/app-green:/g' nginx/nginx.conf
            docker compose restart nginx

      # ------------------ ROLLBACK AUTOMÁTICO ------------------
      - name: Rollback (se falhar)
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          script: |
            sed -i 's/app-green:/app-blue:/g' nginx/nginx.conf
            docker compose restart nginx
